name: lint / rust

on:
  pull_request:
    paths:
      - '**/Cargo.lock'
      - '**/Cargo.toml'

jobs:
  matrix:
    runs-on: ubuntu-latest
    outputs:
      changed-crates: ${{ steps.glob-changed-files.outputs.paths }}
    steps:
      - id: glob-changed-files
        uses: int128/glob-changed-files-action@423f6f37e1288491b5e04cf9c4b150934cfb6428 # v2
        with:
          paths: |
            crates/:crate/Cargo.toml
          transform: |
            :crate

  lockfile:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    needs: matrix
    if: needs.matrix.outputs.changed-crates != ''
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1
      - id: generate-token
        uses: oakcask/gh-token-gen@d65c585678cb39f009f96046d788617e1d0b0745 # v4.0.2
        with:
          app-id: ${{ secrets.TOKEN_GEN_APP_ID }}
          private-key: ${{ secrets.TOKEN_GEN_PRIVATE_KEY }}
      - run: cargo check
      - uses: int128/update-generated-files-action@ce7a724807483f600bd08be3eb85c91297b5d325 # v2
        with:
          commit-message: "chore: update lockfile"
          token: ${{ steps.generate-token.outputs.token }}
