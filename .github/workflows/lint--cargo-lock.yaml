name: lint / rust

on:
  pull_request:
    paths:
      - '**/Cargo.lock'
      - '**/Cargo.toml'

jobs:
  matrix:
    runs-on: ubuntu-latest
    outputs:
      changed-crates: ${{ steps.glob-changed-files.outputs.paths }}
    steps:
      - id: glob-changed-files
        uses: int128/glob-changed-files-action@1a4f75e3ee971fc3840bda9d2cbd260dc87b6998 # v2
        with:
          paths: |
            crates/:crate/Cargo.toml
          transform: |
            :crate

  lockfile:
    runs-on: ubuntu-latest
    needs: matrix
    if: needs.matrix.outputs.changed-crates != ''
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1
      - id: generate-token
        uses: oakcask/gh-token-gen@8265635a8608c36d4e5de582b02d76c0b9fa790a # v4.0.1
        with:
          app-id: ${{ secrets.TOKEN_GEN_APP_ID }}
          private-key: ${{ secrets.TOKEN_GEN_PRIVATE_KEY }}
      - run: cargo check
      - uses: int128/update-generated-files-action@d9aac571db84cee6c16fa20190621e9deb2bc575 # v2
        with:
          commit-message: "chore: update lockfile"
          token: ${{ steps.generate-token.outputs.token }}
